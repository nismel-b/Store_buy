name: Code Quality Check

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  quality:
    name: VÃ©rification de la qualitÃ©
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Configuration de Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.9.2'
          channel: 'stable'
          cache: true

      - name: Installation des dÃ©pendances
        run: flutter pub get

      - name: VÃ©rifier le formatage du code
        run: |
          echo "ğŸ” VÃ©rification du formatage..."
          if ! flutter format --set-exit-if-changed .; then
            echo "âŒ Le code n'est pas formatÃ© correctement"
            echo "ğŸ’¡ ExÃ©cutez: flutter format ."
            exit 1
          fi
          echo "âœ… Formatage OK"

      - name: Analyser le code (dart analyze)
        run: |
          echo "ğŸ” Analyse statique du code..."
          flutter analyze
          echo "âœ… Analyse terminÃ©e"

      - name: VÃ©rifier les imports inutilisÃ©s
        run: |
          echo "ğŸ” Recherche d'imports inutilisÃ©s..."
          flutter pub run dart_code_metrics:metrics check-unused-files lib
        continue-on-error: true

      - name: ExÃ©cuter les tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests..."
          flutter test --coverage
          echo "âœ… Tests terminÃ©s"
        continue-on-error: true

      - name: VÃ©rifier la taille de l'APK
        run: |
          echo "ğŸ“¦ Build de l'APK pour vÃ©rifier la taille..."
          flutter build apk --release
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "ğŸ“Š Taille de l'APK: $APK_SIZE"
        continue-on-error: true

      - name: RÃ©sumÃ© des vÃ©rifications
        if: always()
        run: |
          echo "ğŸ“‹ RÃ©sumÃ© des vÃ©rifications de qualitÃ©"
          echo "=================================="
          echo "âœ… Formatage du code vÃ©rifiÃ©"
          echo "âœ… Analyse statique effectuÃ©e"
          echo "âœ… Tests exÃ©cutÃ©s"
          echo "=================================="